<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Maestro de Sierras - Pro</title>
    <style>
        :root { 
            --stock: #27ae60; 
            --uso: #2980b9; 
            --pendiente: #8e44ad; 
            --afilar: #f39c12; 
            --baja: #e74c3c; 
            --dark: #2c3e50; 
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        
        /* Login Styles */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center; width: 300px;
        }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 10px; background: var(--uso); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Main UI */
        #main-content { display: none; }
        .header-app { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .container { max-width: 1250px; margin: auto; position: relative; }
        
        /* Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 6px solid #ccc; cursor: pointer; transition: 0.2s; }
        .stat-card.active { transform: scale(1.02); border-bottom: 4px solid var(--dark); background: #fffdf5; }
        .stat-card.stock { border-top-color: var(--stock); }
        .stat-card.uso { border-top-color: var(--uso); }
        .stat-card.pendiente { border-top-color: var(--pendiente); }
        .stat-card.afilar { border-top-color: var(--afilar); }
        .stat-card.baja { border-top-color: var(--baja); }
        .stat-value { font-size: 2.5em; font-weight: bold; display: block; }
        .stat-label { font-size: 0.9em; color: #666; font-weight: bold; }

        .nav-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 18px; border: none; border-radius: 6px; background: white; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn.active { background: var(--uso); color: white; }

        .controls-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .panel-busqueda { flex: 1.5; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        
        .panel-registro { flex: 2; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        input[type="text"], select { padding: 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 1em; }
        input[type="text"] { flex: 1; }

        .panel-tabla { background: rgb(113, 186, 255); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #333; font-size: 0.8em; text-transform: uppercase; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; }
        .badge-stock { background: #eafaf1; color: var(--stock); }
        .badge-uso { background: #ebf5fb; color: var(--uso); }
        .badge-pendiente { background: #f4ecf7; color: var(--pendiente); }
        .badge-afilar { background: #fef5e7; color: var(--afilar); }
        .badge-baja { background: #fdedec; color: var(--baja); }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; right: 20px; top: 15px; cursor: pointer; font-size: 28px; color: #888; }
        .historial-item { padding: 12px; border-left: 4px solid var(--uso); margin-bottom: 10px; background: #f9f9f9; border-radius: 0 8px 8px 0; }
        
        .btn-hist { background: var(--dark); color: white; border: none; padding: 7px 12px; border-radius: 5px; cursor: pointer; font-size: 0.75em; }
        .btn-sm { padding: 7px 12px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 0.75em; margin-right: 3px; font-weight: bold; }
        .btn-logout { background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        
        /* Estilo para el indicador de detecci√≥n */
        #regDiamLabel { font-weight: bold; color: var(--uso); background: #eee; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>Acceso al Sistema</h2>
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="Contrase√±a">
            <button onclick="login()">Entrar</button>
            <p id="login-error" style="color:red; font-size:0.8em; margin-top:10px; display:none;">Credenciales incorrectas</p>
        </div>
    </div>

    <div id="main-content" class="container">
        <div class="header-app">
            <img src="logo1.jpg" style="max-width: 80px;" onerror="this.style.display='none'">
            <div>
                <span id="user-display" style="font-weight: bold; margin-right: 15px;"></span>
                <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <h1 style="text-align: center; color: var(--dark); margin-bottom: 30px;">Seguimiento de Sierras Circular</h1>

        <div class="stats-grid">
            <div class="stat-card stock" onclick="filtrarEstado('stock')" id="card-stock">
                <span class="stat-value" id="total-stock">0</span>
                <span class="stat-label">Stock / Listas</span>
            </div>
            <div class="stat-card uso" onclick="filtrarEstado('uso')" id="card-uso">
                <span class="stat-value" id="total-uso">0</span>
                <span class="stat-label">En M√°quina</span>
            </div>
            <div class="stat-card pendiente" onclick="filtrarEstado('pendiente')" id="card-pendiente">
                <span class="stat-value" id="total-pendiente">0</span>
                <span class="stat-label">Por Afilar</span>
            </div>
            <div class="stat-card afilar" onclick="filtrarEstado('afilar')" id="card-afilar">
                <span class="stat-value" id="total-afilar">0</span>
                <span class="stat-label">En Afilado</span>
            </div>
            <div class="stat-card baja" onclick="filtrarEstado('baja')" id="card-baja">
                <span class="stat-value" id="total-baja">0</span>
                <span class="stat-label">Dadas de Baja</span>
            </div>
        </div>

        <div class="nav-tabs" id="tabsDiametros"></div>

        <div class="controls-row">
            <div class="panel-busqueda">
                <span>üîç</span>
                <input type="text" id="inputBuscar" placeholder="Buscar c√≥digo..." onkeyup="render()">
            </div>
            
            <div class="panel-registro" id="panelRegistro" style="display: none;">
                <input type="text" id="nuevoCodigo" placeholder="Ingrese C√≥digo (Ejem: 2045)">
                <select id="nuevoEstado">
                    <option value="stock">Cargar en Stock</option>
                    <option value="uso">Cargar en M√°quina</option>
                    <option value="pendiente">Cargar en "Por Afilar"</option>
                    <option value="afilar">Cargar en "En Afilado"</option>
                </select>
                <button id="btnRegistrar" onclick="agregarSierra()" style="padding: 12px 20px; background: var(--stock); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                    + Registrar √ò <span id="regDiam">---</span>
                </button>
            </div>
        </div>

        <div class="panel-tabla">
            <table id="tablaSierras">
                <thead>
                    <tr>
                        <th>Di√°metro</th>
                        <th>C√≥digo</th>
                        <th>Estado Actual</th>
                        <th>Afilados</th>
                        <th>Hoja de Vida</th>
                        <th class="col-acciones">Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="modalHistorial" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="cerrarModal()">&times;</span>
            <h2 id="modalTitulo" style="margin-top: 0; color: var(--dark);">Historial</h2>
            <div id="listaEventos"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyB1ivVZmMy29zJQbi_5m5mv151jn2k2xPQ", 
            authDomain: "sierras-trazabilidad.firebaseapp.com",
            projectId: "sierras-trazabilidad",
            storageBucket: "sierras-trazabilidad.firebasestorage.app",
            messagingSenderId: "926057948507",
            appId: "1:926057948507:web:4c8d13ec5a5d39de8be67e"
        };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref();

        // --- SISTEMA DE ROLES ---
        let usuarioActual = null;
        const USUARIOS = {
            "PEREZA": { pass: "A12PZ", rol: "supervisor", nombre: "Supervisor" },
            "operario": { pass: "1234", rol: "operario", nombre: "Operario Taller" }
        };

        function login() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            if(USUARIOS[u] && USUARIOS[u].pass === p) {
                usuarioActual = USUARIOS[u];
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('user-display').innerText = `Sesi√≥n: ${usuarioActual.nombre}`;
                document.getElementById('panelRegistro').style.display = usuarioActual.rol === 'supervisor' ? 'flex' : 'none';
                render();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function logout() {
            usuarioActual = null;
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('user').value = "";
            document.getElementById('pass').value = "";
        }

        // --- L√ìGICA DE NEGOCIO ---
        const diametros = [520, 430, 380, 350, 200];
        let dActual = null;
        let eActual = null;
        let db = {};

        dbRef.on('value', (snapshot) => {
            db = snapshot.val() || {};
            diametros.forEach(d => { if (!db[d]) db[d] = []; });
            render();
        });

        function guardar() { dbRef.set(db); }

        // --- DETECCI√ìN AUTOM√ÅTICA DE DI√ÅMETRO ---
        function obtenerDiametroPorCodigo(codigo) {
            const num = parseInt(codigo.replace(/\D/g, "")); 
            if (isNaN(num)) return null;

            if (num >= 3000) return 200;  // 3000 para arriba
            if (num >= 2000) return 520;  // 2000-2999
            if (num >= 1000) return 430;  // 1000-1999
            if (num >= 500)  return 380;  // 500-999
            if (num >= 100)  return 350;  // 100-499
            return null;
        }

        // Feedback en tiempo real al escribir c√≥digo
        document.getElementById('nuevoCodigo').addEventListener('input', (e) => {
            const d = obtenerDiametroPorCodigo(e.target.value);
            const btn = document.getElementById('btnRegistrar');
            const label = document.getElementById('regDiam');
            if(d) {
                label.innerText = d;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            } else {
                label.innerText = "---";
                btn.style.opacity = "0.6";
            }
        });

        function agregarSierra() {
            if(usuarioActual.rol !== 'supervisor') return;
            const codInput = document.getElementById('nuevoCodigo');
            const cod = codInput.value.trim().toUpperCase();
            const estadoInic = document.getElementById('nuevoEstado').value;
            
            if (!cod) return alert("Ingrese un c√≥digo");
            
            const diam = obtenerDiametroPorCodigo(cod);
            if (!diam) return alert("‚ùå C√≥digo fuera de rango v√°lido.");

            const existe = Object.values(db).flat().find(s => s.id === cod);
            if(existe) return alert("‚ö†Ô∏è C√≥digo duplicado en el sistema");

            db[diam].push({
                id: cod, 
                estado: estadoInic, 
                afilados: 0,
                eventos: [{ fecha: new Date().toLocaleString(), msg: `Alta autom√°tica en √ò${diam}mm por ${usuarioActual.nombre}` }]
            });

            codInput.value = '';
            document.getElementById('regDiam').innerText = "---";
            guardar();
            alert(`‚úÖ Registrada sierra ${cod} en medida √ò${diam}mm`);
        }

        function mover(diam, cod, nuevoEstado) {
            if(usuarioActual.rol !== 'supervisor') return;
            const s = db[diam].find(x => x.id === cod);
            let mensaje = `Cambiado a ${nuevoEstado.toUpperCase()} por ${usuarioActual.nombre}`;

            if (nuevoEstado === 'stock' && s.estado === 'afilar') s.afilados++;
            
            s.estado = nuevoEstado;
            s.eventos.push({ fecha: new Date().toLocaleString(), msg: mensaje });
            guardar();
        }

        function verHistorial(diam, cod) {
            const s = db[diam].find(x => x.id === cod);
            document.getElementById('modalTitulo').innerText = `Historial: ${cod} (√ò${diam}mm)`;
            document.getElementById('listaEventos').innerHTML = s.eventos.map(e => `
                <div class="historial-item">
                    <small>üìÖ ${e.fecha}</small><br>
                    <strong>${e.msg}</strong>
                </div>
            `).reverse().join('');
            document.getElementById('modalHistorial').style.display = "block";
        }

        function cerrarModal() { document.getElementById('modalHistorial').style.display = "none"; }

        function render() {
            if(!usuarioActual) return;
            const busqueda = document.getElementById('inputBuscar').value.toLowerCase();
            
            // Render Tabs
            document.getElementById('tabsDiametros').innerHTML = `<button class="tab-btn ${!dActual ? 'active' : ''}" onclick="dActual=null;render()">TODAS</button>` + 
                diametros.map(d => `<button class="tab-btn ${d===dActual?'active':''}" onclick="dActual=${d};render()">${d}mm</button>`).join('');

            // Totales
            const tot = { stock: 0, uso: 0, pendiente: 0, afilar: 0, baja: 0 };
            diametros.forEach(d => db[d].forEach(s => tot[s.estado]++));
            for (let k in tot) {
                document.getElementById(`total-${k}`).innerText = tot[k];
                document.getElementById(`card-${k}`).classList.toggle('active', eActual === k);
            }

            // Tabla
            let html = "";
            const esSup = usuarioActual.rol === 'supervisor';
            
            diametros.forEach(d => {
                db[d].forEach(s => {
                    const cumpleFiltroDiam = !dActual || d === dActual;
                    const cumpleFiltroEstado = !eActual || s.estado === eActual;
                    const cumpleBusqueda = s.id.toLowerCase().includes(busqueda);

                    if (cumpleFiltroDiam && cumpleFiltroEstado && cumpleBusqueda) {
                        html += `<tr>
                            <td><b>${d}mm</b></td>
                            <td><code>${s.id}</code></td>
                            <td><span class="badge badge-${s.estado}">${s.estado}</span></td>
                            <td>üîÅ ${s.afilados}</td>
                            <td><button class="btn-hist" onclick="verHistorial(${d},'${s.id}')">Ver Hoja</button></td>
                            ${esSup ? `<td>
                                ${s.estado==='stock'?`<button class="btn-sm" style="background:var(--uso)" onclick="mover(${d},'${s.id}','uso')">Poner</button>`:''}
                                ${s.estado==='uso'?`<button class="btn-sm" style="background:var(--pendiente)" onclick="mover(${d},'${s.id}','pendiente')">Retirar</button>`:''}
                                ${s.estado==='pendiente'?`<button class="btn-sm" style="background:var(--afilar)" onclick="mover(${d},'${s.id}','afilar')">Enviar</button>`:''}
                                ${s.estado==='afilar'?`<button class="btn-sm" style="background:var(--stock)" onclick="mover(${d},'${s.id}','stock')">Recibir</button>`:''}
                                <button class="btn-sm" style="background:var(--baja)" onclick="mover(${d},'${s.id}','baja')">Baja</button>
                            </td>` : '<td style="display:none"></td>'}
                        </tr>`;
                    }
                });
            });
            document.querySelector("#tablaSierras tbody").innerHTML = html;
            document.querySelectorAll('.col-acciones').forEach(el => el.style.display = esSup ? '' : 'none');
        }

        function filtrarEstado(e) { eActual = (eActual === e) ? null : e; render(); }
        window.onclick = function(e) { if (e.target.className == 'modal') cerrarModal(); }
    </script>
</body>
</html>

