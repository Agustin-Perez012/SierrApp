<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Maestro de Sierras - Pro</title>
    <style>
        :root { --stock: #27ae60; --uso: #2980b9; --afilar: #f39c12; --baja: #e74c3c; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #ffffff; margin: 20px; }
        .container { max-width: 1200px; margin: auto; }
        
        /* Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: rgb(255, 255, 255); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 6px solid #ccc; cursor: pointer; transition: 0.2s; }
        .stat-card.active { transform: scale(1.02); border-bottom: 4px solid var(--dark); background: #fffdf5; }
        .stat-card.stock { border-top-color: var(--stock); }
        .stat-card.uso { border-top-color: var(--uso); }
        .stat-card.afilar { border-top-color: var(--afilar); }
        .stat-card.baja { border-top-color: var(--baja); }
        .stat-value { font-size: 2.5em; font-weight: bold; display: block; }

        .nav-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 18px; border: none; border-radius: 6px; background: white; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn.active { background: var(--uso); color: white; }

        /* Buscador y Registro */
        .controls-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .panel-busqueda { flex: 2; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        .panel-registro { flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        
        input[type="text"] { padding: 12px; border-radius: 6px; border: 1px solid #ddd; width: 100%; font-size: 1em; }
        .search-icon { font-size: 1.2em; }

        /* Tabla y Badges */
        .panel-tabla { background: rgb(124, 162, 218); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #000000; font-size: 0.8em; text-transform: uppercase; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; }
        .badge-stock { background: #eafaf1; color: var(--stock); }
        .badge-uso { background: #ebf5fb; color: var(--uso); }
        .badge-afilar { background: #fef5e7; color: var(--afilar); }
        .badge-baja { background: #fdedec; color: var(--baja); }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; right: 20px; top: 15px; cursor: pointer; font-size: 28px; color: #888; }
        .historial-item { padding: 12px; border-left: 4px solid var(--uso); margin-bottom: 10px; background: #f9f9f9; border-radius: 0 8px 8px 0; }
        .historial-item small { color: #888; display: block; margin-bottom: 4px; }

        .btn-hist { background: var(--dark); color: white; border: none; padding: 7px 12px; border-radius: 5px; cursor: pointer; font-size: 0.75em; }
        .btn-sm { padding: 7px 12px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 0.75em; margin-right: 3px; font-weight: bold; }
    .logo-empresa {
            position: absolute;
            top: 10px;
            left: 10px;
            max-width: 80px; /* Ajusta el tama√±o a tu gusto */
            height: auto;
            z-index: 1000;
        }

        /* Esto evita que el t√≠tulo choque con el logo */
        .container {
            position: relative;
            padding-top: 10px;
        }
    </style>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<body>
    <img src="logo1.jpg" class="logo-empresa">

    <div class="container">
    <h1 style="text-align: center; color: var(--dark); margin-bottom: 30px;">Seguimiento de Sierras Circular</h1>

    <div class="stats-grid">
        <div class="stat-card stock" onclick="filtrarEstado('stock')" id="card-stock">
            <span class="stat-value" id="total-stock">0</span>
            <span class="stat-label">Stock / Listas</span>
        </div>
        <div class="stat-card uso" onclick="filtrarEstado('uso')" id="card-uso">
            <span class="stat-value" id="total-uso">0</span>
            <span class="stat-label">En M√°quina</span>
        </div>
        <div class="stat-card afilar" onclick="filtrarEstado('afilar')" id="card-afilar">
            <span class="stat-value" id="total-afilar">0</span>
            <span class="stat-label">En Afilado</span>
        </div>
        <div class="stat-card baja" onclick="filtrarEstado('baja')" id="card-baja">
            <span class="stat-value" id="total-baja">0</span>
            <span class="stat-label">Dadas de Baja</span>
        </div>
    </div>

    <div class="nav-tabs" id="tabsDiametros"></div>

    <div class="controls-row">
        <div class="panel-busqueda">
            <span class="search-icon">üîç</span>
            <input type="text" id="inputBuscar" placeholder="Buscar por c√≥digo de sierra..." onkeyup="render()">
        </div>
        <div class="panel-registro">
            <input type="text" id="nuevoCodigo" placeholder="Nuevo C√≥digo">
            <button onclick="agregarSierra()" style="padding: 12px 20px; background: var(--stock); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap;">+ Registrar en √ò <span id="regDiam">520</span></button>
        </div>
    </div>

    <div class="panel-tabla">
        <table id="tablaSierras">
            <thead>
                <tr>
                    <th>Di√°metro</th>
                    <th>C√≥digo</th>
                    <th>Estado Actual</th>
                    <th>Afilados</th>
                    <th>Hoja de Vida</th>
                    <th>Acciones de Movimiento</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="modalHistorial" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="cerrarModal()">&times;</span>
        <h2 id="modalTitulo" style="margin-top: 0; color: var(--dark);">Historial</h2>
        <div id="listaEventos"></div>
    </div>
</div>

<script>
    // 1. Pega aqu√≠ los datos que te d√© la consola de Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB1ivVZmMy29zJQbi_5m5m...", // Aseg√∫rate de poner la clave completa que viste en la alerta
  authDomain: "sierras-trazabilidad.firebaseapp.com",
  projectId: "sierras-trazabilidad",
  storageBucket: "sierras-trazabilidad.firebasestorage.app",
  messagingSenderId: "926057948507",
  appId: "1:926057948507:web:4c8d13ec5a5d39de8be67e",
  measurementId: "G-0V2W2VPYJ0"
};
    let eActual = null;
    let db = {};

    // 3. Escuchar datos en tiempo real (Sustituye al localStorage)
    dbRef.on('value', (snapshot) => {
        const data = snapshot.val();
        db = data || {};
        diametros.forEach(d => { if (!db[d]) db[d] = []; });
        render(); // Se actualiza solo cada vez que Firebase detecta un cambio
    });

    function guardar() {
        // Esto guarda el objeto 'db' completo en tu Firebase
        dbRef.set(db);
    }

    function agregarSierra() {
        const cod = document.getElementById('nuevoCodigo').value.trim().toUpperCase();
        if (!cod) return;
        const diam = dActual || 520;
        
        // Evitar duplicados
        const existe = Object.values(db).flat().find(s => s.id === cod);
        if(existe) return alert("¬°Atenci√≥n! El c√≥digo " + cod + " ya est√° registrado.");

        db[diam].push({
            id: cod, 
            estado: 'stock', 
            afilados: 0,
            eventos: [{ fecha: new Date().toLocaleString(), msg: "Sierra registrada en el sistema." }]
        });
        document.getElementById('nuevoCodigo').value = '';
        guardar();
    }

    function mover(diam, cod, nuevoEstado) {
        const s = db[diam].find(x => x.id === cod);
        let mensaje = `Movimiento: Sierra enviada a ${nuevoEstado.toUpperCase()}.`;
        
        if (s.estado === 'afilar' && nuevoEstado === 'stock') {
            s.afilados++;
            mensaje = "Regreso de Afilado: Sierra lista para usar nuevamente.";
        }
        if (nuevoEstado === 'baja') mensaje = "BAJA: Sierra retirada de circulaci√≥n.";
        
        s.estado = nuevoEstado;
        s.eventos.push({ fecha: new Date().toLocaleString(), msg: mensaje });
        guardar();
    }

    function verHistorial(diam, cod) {
        const s = db[diam].find(x => x.id === cod);
        document.getElementById('modalTitulo').innerText = `Detalle: Sierra ${cod} (√ò ${diam}mm)`;
        document.getElementById('listaEventos').innerHTML = s.eventos.map(e => `
            <div class="historial-item">
                <small>üìÖ ${e.fecha}</small>
                <strong>${e.msg}</strong>
            </div>
        `).reverse().join('');
        document.getElementById('modalHistorial').style.display = "block";
    }

    function cerrarModal() { document.getElementById('modalHistorial').style.display = "none"; }

    function render() {
        const busqueda = document.getElementById('inputBuscar').value.toLowerCase();
        
        // Tabs
        document.getElementById('tabsDiametros').innerHTML = `<button class="tab-btn ${!dActual && !eActual ? 'active' : ''}" onclick="dActual=eActual=null;render()">TODAS LAS MEDIDAS</button>` + 
            diametros.map(d => `<button class="tab-btn ${d===dActual?'active':''}" onclick="dActual=${d};eActual=null;render()">${d}mm</button>`).join('');

        document.getElementById('regDiam').innerText = dActual || 520;

        // Totales
        const tot = { stock: 0, uso: 0, afilar: 0, baja: 0 };
        diametros.forEach(d => db[d].forEach(s => tot[s.estado]++));
        for (let k in tot) {
            document.getElementById(`total-${k}`).innerText = tot[k];
            document.getElementById(`card-${k}`).classList.toggle('active', eActual === k);
        }

        // Render de Tabla con Filtros y Buscador
        let html = "";
        diametros.forEach(d => {
            db[d].forEach(s => {
                const cumpleDiam = !dActual || d === dActual;
                const cumpleEstado = !eActual || s.estado === eActual;
                const cumpleBusqueda = s.id.toLowerCase().includes(busqueda);

                if (cumpleDiam && cumpleEstado && cumpleBusqueda) {
                    html += `<tr>
                        <td><span style="font-weight:bold; color:#000">${d}mm</span></td>
                        <td><code style="font-size:1.1em; background:#f0f0f0; padding:2px 5px; border-radius:3px">${s.id}</code></td>
                        <td><span class="badge badge-${s.estado}">${s.estado}</span></td>
                        <td><span style="font-weight:bold">üîÅ ${s.afilados}</span></td>
                        <td><button class="btn-hist" onclick="verHistorial(${d},'${s.id}')">Ver Hoja de Vida</button></td>
                        <td>
                            ${s.estado==='stock'?`<button class="btn-sm" style="background:var(--uso)" onclick="mover(${d},'${s.id}','uso')">A M√°quina</button>`:''}
                            ${s.estado==='uso'?`<button class="btn-sm" style="background:var(--afilar)" onclick="mover(${d},'${s.id}','afilar')">A Afilar</button>`:''}
                            ${s.estado==='afilar'?`<button class="btn-sm" style="background:var(--stock)" onclick="mover(${d},'${s.id}','stock')">Recibir Afilada</button>`:''}
                            ${s.estado!=='baja'?`<button class="btn-sm" style="background:var(--baja)" onclick="mover(${d},'${s.id}','baja')">Dar de Baja</button>`:''}
                        </td>
                    </tr>`;
                }
            });
        });
        document.querySelector("#tablaSierras tbody").innerHTML = html || '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999">No se encontraron sierras con esos criterios.</td></tr>';
    }

    function filtrarEstado(e) { eActual = e; dActual = null; render(); }

    render();
    window.onclick = function(event) { if (event.target == document.getElementById('modalHistorial')) cerrarModal(); }
</script>
</body>
</html>











