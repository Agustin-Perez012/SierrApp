<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Maestro de Sierras - Pro</title>
    <style>
        /* Se agreg贸 el color morado para el nuevo estado 'pendiente' */
        :root { 
            --stock: #27ae60; 
            --uso: #2980b9; 
            --pendiente: #8e44ad; /* Color para preparaci贸n */
            --afilar: #f39c12; 
            --baja: #e74c3c; 
            --dark: #2c3e50; 
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #ffffff; margin: 20px; }
        .container { max-width: 1250px; margin: auto; }
        
        /* Dashboard: Ahora con 5 columnas para que entre el nuevo estado */
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: rgb(255, 255, 255); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 6px solid #ccc; cursor: pointer; transition: 0.2s; }
        .stat-card.active { transform: scale(1.02); border-bottom: 4px solid var(--dark); background: #fffdf5; }
        .stat-card.stock { border-top-color: var(--stock); }
        .stat-card.uso { border-top-color: var(--uso); }
        .stat-card.pendiente { border-top-color: var(--pendiente); }
        .stat-card.afilar { border-top-color: var(--afilar); }
        .stat-card.baja { border-top-color: var(--baja); }
        .stat-value { font-size: 2.5em; font-weight: bold; display: block; }
        .stat-label { font-size: 0.9em; color: #666; font-weight: bold; }

        .nav-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 18px; border: none; border-radius: 6px; background: white; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn.active { background: var(--uso); color: white; }

        .controls-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .panel-busqueda { flex: 2; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        .panel-registro { flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        
        input[type="text"] { padding: 12px; border-radius: 6px; border: 1px solid #ddd; width: 100%; font-size: 1em; }
        .search-icon { font-size: 1.2em; }

        .panel-tabla { background: rgb(124, 162, 218); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #000000; font-size: 0.8em; text-transform: uppercase; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; }
        .badge-stock { background: #eafaf1; color: var(--stock); }
        .badge-uso { background: #ebf5fb; color: var(--uso); }
        .badge-pendiente { background: #f4ecf7; color: var(--pendiente); }
        .badge-afilar { background: #fef5e7; color: var(--afilar); }
        .badge-baja { background: #fdedec; color: var(--baja); }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; right: 20px; top: 15px; cursor: pointer; font-size: 28px; color: #888; }
        .historial-item { padding: 12px; border-left: 4px solid var(--uso); margin-bottom: 10px; background: #f9f9f9; border-radius: 0 8px 8px 0; }
        .historial-item small { color: #888; display: block; margin-bottom: 4px; }

        .btn-hist { background: var(--dark); color: white; border: none; padding: 7px 12px; border-radius: 5px; cursor: pointer; font-size: 0.75em; }
        .btn-sm { padding: 7px 12px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 0.75em; margin-right: 3px; font-weight: bold; }
        .logo-empresa { position: absolute; top: 10px; left: 10px; max-width: 80px; height: auto; z-index: 1000; }
        .container { position: relative; padding-top: 10px; }
    </style>
</head>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
<body>
    <img src="logo1.jpg" class="logo-empresa">

    <div class="container">
    <h1 style="text-align: center; color: var(--dark); margin-bottom: 30px;">Seguimiento de Sierras Circular</h1>

    <div class="stats-grid">
        <div class="stat-card stock" onclick="filtrarEstado('stock')" id="card-stock">
            <span class="stat-value" id="total-stock">0</span>
            <span class="stat-label">Stock / Listas</span>
        </div>
        <div class="stat-card uso" onclick="filtrarEstado('uso')" id="card-uso">
            <span class="stat-value" id="total-uso">0</span>
            <span class="stat-label">En M谩quina</span>
        </div>
        <div class="stat-card pendiente" onclick="filtrarEstado('pendiente')" id="card-pendiente">
            <span class="stat-value" id="total-pendiente">0</span>
            <span class="stat-label">Por Afilar</span>
        </div>
        <div class="stat-card afilar" onclick="filtrarEstado('afilar')" id="card-afilar">
            <span class="stat-value" id="total-afilar">0</span>
            <span class="stat-label">En Afilado</span>
        </div>
        <div class="stat-card baja" onclick="filtrarEstado('baja')" id="card-baja">
            <span class="stat-value" id="total-baja">0</span>
            <span class="stat-label">Dadas de Baja</span>
        </div>
    </div>

    <div class="nav-tabs" id="tabsDiametros"></div>

    <div class="controls-row">
        <div class="panel-busqueda">
            <span class="search-icon"></span>
            <input type="text" id="inputBuscar" placeholder="Buscar por c贸digo de sierra..." onkeyup="render()">
        </div>
        <div class="panel-registro">
            <input type="text" id="nuevoCodigo" placeholder="Nuevo C贸digo">
            <button onclick="agregarSierra()" style="padding: 12px 20px; background: var(--stock); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap;">+ Registrar en  <span id="regDiam">520</span></button>
        </div>
    </div>

    <div class="panel-tabla">
        <table id="tablaSierras">
            <thead>
                <tr>
                    <th>Di谩metro</th>
                    <th>C贸digo</th>
                    <th>Estado Actual</th>
                    <th>Afilados</th>
                    <th>Hoja de Vida</th>
                    <th>Acciones de Movimiento</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="modalHistorial" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="cerrarModal()">&times;</span>
        <h2 id="modalTitulo" style="margin-top: 0; color: var(--dark);">Historial</h2>
        <div id="listaEventos"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyB1ivVZmMy29zJQbi_5m5mv151jn2k2xPQ", 
      authDomain: "sierras-trazabilidad.firebaseapp.com",
      projectId: "sierras-trazabilidad",
      storageBucket: "sierras-trazabilidad.firebasestorage.app",
      messagingSenderId: "926057948507",
      appId: "1:926057948507:web:4c8d13ec5a5d39de8be67e",
      measurementId: "G-0V2W2VPYJ0"
    };

    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref();

    const diametros = [520, 430, 380, 350, 200];
    let dActual = null;
    let eActual = null;
    let db = {};

    dbRef.on('value', (snapshot) => {
        const data = snapshot.val();
        db = data || {};
        diametros.forEach(d => { if (!db[d]) db[d] = []; });
        render();
    });

    function guardar() {
        dbRef.set(db);
    }

    function agregarSierra() {
        const cod = document.getElementById('nuevoCodigo').value.trim().toUpperCase();
        if (!cod) return;
        const diam = dActual || 520;
        const existe = Object.values(db).flat().find(s => s.id === cod);
        if(existe) return alert("隆Atenci贸n! El c贸digo " + cod + " ya est谩 registrado.");

        db[diam].push({
            id: cod, 
            estado: 'stock', 
            afilados: 0,
            eventos: [{ fecha: new Date().toLocaleString(), msg: "Sierra registrada en el sistema." }]
        });
        document.getElementById('nuevoCodigo').value = '';
        guardar();
    }

    function mover(diam, cod, nuevoEstado) {
        const s = db[diam].find(x => x.id === cod);
        let mensaje = "";

        // L贸gica de mensajes mejorada
        if (nuevoEstado === 'uso') mensaje = "Sierra montada en m谩quina.";
        if (nuevoEstado === 'pendiente') mensaje = "Retirada de m谩quina. En preparaci贸n para afilado.";
        if (nuevoEstado === 'afilar') mensaje = "Sierra enviada a taller de afilado.";
        if (nuevoEstado === 'stock') {
            if (s.estado === 'afilar') {
                s.afilados++;
                mensaje = "Regreso de Afilado: Sierra lista para usar nuevamente.";
            } else {
                mensaje = "Sierra devuelta a Stock.";
            }
        }
        if (nuevoEstado === 'baja') mensaje = "BAJA: Sierra retirada de circulaci贸n.";
        
        s.estado = nuevoEstado;
        s.eventos.push({ fecha: new Date().toLocaleString(), msg: mensaje });
        guardar();
    }

    function verHistorial(diam, cod) {
        const s = db[diam].find(x => x.id === cod);
        document.getElementById('modalTitulo').innerText = `Detalle: Sierra ${cod} ( ${diam}mm)`;
        document.getElementById('listaEventos').innerHTML = s.eventos.map(e => `
            <div class="historial-item">
                <small> ${e.fecha}</small>
                <strong>${e.msg}</strong>
            </div>
        `).reverse().join('');
        document.getElementById('modalHistorial').style.display = "block";
    }

    function cerrarModal() { document.getElementById('modalHistorial').style.display = "none"; }

    function render() {
        const busqueda = document.getElementById('inputBuscar').value.toLowerCase();
        
        document.getElementById('tabsDiametros').innerHTML = `<button class="tab-btn ${!dActual && !eActual ? 'active' : ''}" onclick="dActual=eActual=null;render()">TODAS LAS MEDIDAS</button>` + 
            diametros.map(d => `<button class="tab-btn ${d===dActual?'active':''}" onclick="dActual=${d};eActual=null;render()">${d}mm</button>`).join('');

        document.getElementById('regDiam').innerText = dActual || 520;

        // Totales (incluyendo 'pendiente')
        const tot = { stock: 0, uso: 0, pendiente: 0, afilar: 0, baja: 0 };
        diametros.forEach(d => db[d].forEach(s => { if(tot[s.estado] !== undefined) tot[s.estado]++; }));
        
        for (let k in tot) {
            const el = document.getElementById(`total-${k}`);
            if(el) el.innerText = tot[k];
            const card = document.getElementById(`card-${k}`);
            if(card) card.classList.toggle('active', eActual === k);
        }

        let html = "";
        diametros.forEach(d => {
            db[d].forEach(s => {
                const cumpleDiam = !dActual || d === dActual;
                const cumpleEstado = !eActual || s.estado === eActual;
                const cumpleBusqueda = s.id.toLowerCase().includes(busqueda);

                if (cumpleDiam && cumpleEstado && cumpleBusqueda) {
                    // Traducci贸n visual de estados
                    let nombreEstado = s.estado;
                    if(s.estado === 'pendiente') nombreEstado = 'Por Afilar';
                    if(s.estado === 'uso') nombreEstado = 'En M谩quina';

                    html += `<tr>
                        <td><span style="font-weight:bold; color:#000">${d}mm</span></td>
                        <td><code style="font-size:1.1em; background:#f0f0f0; padding:2px 5px; border-radius:3px">${s.id}</code></td>
                        <td><span class="badge badge-${s.estado}">${nombreEstado}</span></td>
                        <td><span style="font-weight:bold"> ${s.afilados}</span></td>
                        <td><button class="btn-hist" onclick="verHistorial(${d},'${s.id}')">Ver Hoja de Vida</button></td>
                        <td>
                            ${s.estado==='stock'?`<button class="btn-sm" style="background:var(--uso)" onclick="mover(${d},'${s.id}','uso')">A M谩quina</button>`:''}
                            
                            ${s.estado==='uso'?`<button class="btn-sm" style="background:var(--pendiente)" onclick="mover(${d},'${s.id}','pendiente')">Retirar para Afilado</button>`:''}
                            
                            ${s.estado==='pendiente'?`<button class="btn-sm" style="background:var(--afilar)" onclick="mover(${d},'${s.id}','afilar')">Enviar a Taller</button>`:''}
                            
                            ${s.estado==='afilar'?`<button class="btn-sm" style="background:var(--stock)" onclick="mover(${d},'${s.id}','stock')">Recibir Afilada</button>`:''}
                            
                            ${s.estado!=='baja'?`<button class="btn-sm" style="background:var(--baja)" onclick="mover(${d},'${s.id}','baja')">Baja</button>`:''}
                        </td>
                    </tr>`;
                }
            });
        });
        document.querySelector("#tablaSierras tbody").innerHTML = html || '<tr><td colspan="6" style="text-align:center; padding:30px; color:#999">No se encontraron sierras.</td></tr>';
    }

    function filtrarEstado(e) { eActual = e; dActual = null; render(); }
    render();
    window.onclick = function(event) { if (event.target == document.getElementById('modalHistorial')) cerrarModal(); }
</script>
</body>
</html>
